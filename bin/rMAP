#! /bin/bash
# set -eu
# sed -i 's/\r//' rMAP - strips out any trailing spaces that can't be interpreted by bash/unix(https://stackoverflow.com/questions/6473766/syntax-error-near-unexpected-token-in-r)
#Resolve parent-directory till it's nolonger a symbolic link
rMAP=$0
cd
while [ -h "$rMAP" ]; do
    rMAPDIR="$(cd -P "$(dirname "$0")" && pwd)"
    rMAP="$(readlink "$rMAP")"
    [[ $rMAP != /* ]] && rMAP="rMAPDIR/$rMAP"
done
rMAPDIR="$(cd -P "$(dirname "$rMAP")" && pwd)"

#Defining Color codes
Off="\e[0m"       # Text Reset
Red="\e[1;31m"    # Red
Yellow="\e[1;33m" # Yellow
Blue="\e[1;34m"   # Blue
Grey="\e[1;30m"   # Dark_Grey
Green="\e[1;32m"  # Green
Purple="\e[1;35m" # Purple
Cyan="\e[1;36m"   # Cyan
White="\e[1;37m"  # White
#Variables
TAB="$(printf '\t')"
OUTPUT=
ADAPTERS="$rMAPDIR/../config-files/adapters.fa"
ASSEMBLY="megahit"
CPUS=4
MINLEN=80
INPUT=
OUTPUT=
CONFIG=0
QUALITY=27
REFERENCE=
VARCALL=0
AMR=0
PHY=0
MGE=0
PANGENOME=0
LIS="~/list.txt"
DOWNLOAD=0
MGE=0
TITLE=
QC=0
TRIM=0
VERSION="1.0"
rMAP=$0
ARGPARSED0=$0
ALLARGSPARSED=$@
# echo -e $Red
logo() {
    cat <<'EOF'
  _ \             _)      |    \  | _)                |    _)         |     \                 |            _)        _ \ _)             | _)             
    /   _` |  _ \  |   _` |   |\/ |  |   _|   _| _ \   _ \  |   _` |  |    _ \     \    _` |  |  |  | (_-<  | (_-<   __/  |  _ \   -_)  |  |    \    -_) 
 _|_\ \__,_| .__/ _| \__,_|  _|  _| _| \__| _| \___/ _.__/ _| \__,_| _|  _/  _\ _| _| \__,_| _| \_, | ___/ _| ___/  _|   _| .__/ \___| _| _| _| _| \___| 
            _|                                                                                  ___/                       _|                            
                                                                                                                                                  v.1.0

                                                                                                         __   _,--="=--,_   __
                                                                                                        /  \."    .-.    "./  \
                                                                                                       /  ,/  _   : :   _  \/` \
                                                                                                       \  `| /o\  :_:  /o\ |\__/
                                                                                                        `-'| :="~` _ `~"=: |
                                                                                                           \`     (_)     `/
                                                                                                    .-"-.   \      |      /   .-"-.
                                                                                            .------{     }--|  /,.-'-.,\  |--{     }-----.
                                                                                             )     (_)_)_)  \_/`~-===-~`\_/  (_(_(_)    (
                                                                                             (     RAPID MICROBIAL ANALYSIS PIPELINE    )
                                                                                             )                                          (

EOF
}
# echo -e $Off
echo -e $Blue
usage() {
    cat <<EOF
This is rMAP $VERSION
Developed and maintained by Ivan Sserwadda & Gerald Mboowa

SYPNOSIS:
    Bacterial analysis toolbox for profiling the resistome of ESKAPE pathogens using WGS paired-end reads

USAGE: 
    rMAP [options] --input <DIR> --output <OUTDIR> --reference <REF> 

GENERAL:
    -h/--help       Show this help menu
    -v/--version    Print version and exit
    -x/--citation   Show citation and exit

OBLIGATORY OPTIONS:
    -i/--input      Location of the raw sequences to be analyzed by the pipeline [either .fastq or .fastq.gz]

    -o/--output     Path and name of the output directory

    -r/--reference  Path to reference genome(.gbk). Provide '.gbk' to get annotated vcf files and insertion 
                    sequences  [default="REF.gbk"]  

    -c/--config     Install and configure full software dependencies  

OTHER OPTIONS:
    -d/--download   Download sequences from NCBI-SRA. Requires 'list.txt' of  sample ids saved at $HOME 
                    directory

    -f/--quality    Generate .html reports with quality statistics for the samples

    -q/--trim       Trims adapters off raw reads to a phred quality score[default=$QUALITY]

    -a/--assembly   Perform De novo assembly [default=$ASSEMBLY] Choose either 'shovill' or 'megahit'

    -vc/--varcall   Generates SNPs for each sample and a merged 'all-sample ID' VCF file to be used to infer 
                    phylogeny in downstream analysis

    -t/--threads    Number of threads to use <integer> [default=$CPUS]

    -m/--amr        Profiles any existing antimicrobial resistance genes, virulence factors, mlsts and plasmids 
                    present within each sample id. 

    -p/--phylogeny  Infers phylogeny using merged all-sample ID VCF file to determine diversity and evolutionary 
                    relationships using Maximum Likelihood(ML) in 1000 Bootstraps
    
    -s/--pangenome  Perform pangenome analysis. A minimum of 3 samples should be provided to run this option
    
    -g/--gen-ele    Interrogates and profiles for mobile genomic elements(MGE) and insertion sequeces(IS) that 
                    may exist in the sequences
                     
For further explanation please visit: https://github.com/GunzIvan28/rMAP
EOF
}

echo -e $Off
if [ $# == 0 ]; then
    logo
    usage
    exit 1
fi

################ OPTIONS #########################
POSITIONAL=()
while [[ $# -gt 0 ]]; do
    ARGS="$1"
    case $ARGS in
    -i | --input)
        if [ "$2" ]; then
            INPUT=$2
            shift 2
        fi
        ;;
    -o | --output)
        if [ "$2" ]; then
            OUTPUT=$2
            shift 2
        fi
        ;;

    -d | --download)
        DOWNLOAD=1
        shift
        ;;
    -a | --assembly)
        if [[ "$2" ]]; then
            if [ $2 == 'shovill' ] || [ $2 == 'megahit' ]; then
                ASSEMBLY=$2
                shift 2
            fi
        fi
        ;;
    -f | --quality)
        QC=1
        shift
        ;;

    -q | --trim)
        TRIM=$2
        shift
        ;;

    -r | --reference)
        if [ "$2" ]; then
            VARCALL=1
            REFERENCE=$2
            shift 2
        fi
        ;;

    -vc | --varcall)
        VARCALL=1
        shift
        ;;

    -s | --pangenome)
        PANGENOME=1
        shift
        ;;

    -m | --amr)
        AMR=1
        shift
        ;;

    -p | --phylogeny)
        PHY=1
        shift
        ;;
    -g | --gen-ele)
        MGE=1
        shift
        ;;
    -c | --config)
        CONFIG=1
        shift
        ;;
    -t | --threads)
        if [ "$2" -eq "$2" ] 2>/dev/null; then
            CPUS=$2
            shift 2
        else
            echo -e '\nERROR: "-t/--threads" requires a numeric argument\n'
            echo -e "Selected cores: $2\n"
            exit 1
        fi
        ;;

    -h | --help)
        logo
        usage
        exit 1
        ;;
    -v | --version)
        echo "This is rMAP version $VERSION"
        exit 1
        ;;
    -x | --citation)
        echo -e "\nIf using rMAP, please cite:"
        echo -e "Sserwadda, I, Mboowa, G.(2020). rMAP: Rapid Microbial Analysis and Profiling pipeline for Whole-genome sequencing (WGS) High-throughput sequencing (HTS) data."
        exit 1
        ;;

    *)
        echo -e "\nERROR: unknown option: $1 \n"
        usage
        exit 1
        ;;
    esac

done
set -- "${POSITIONAL[@]}" #restore positional parameters
# ####------------------------------------------------------------EOF MENU-------------------------------------------------####
